<!DOCTYPE html>
<html>
<head>
    <title>AR Drag & Drop Fixed</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>

    <style>
        /* --- UI修正: ボタンを画面上部に配置 --- */
        #ui-overlay {
            position: fixed;
            top: 20px; /* 下ではなく上に配置 */
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 9999;
            pointer-events: none; /* ボタン以外はタップを透過 */
            display: none;
        }
        .btn {
            pointer-events: auto; /* ボタンは押せるように */
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid #fff;
            padding: 12px 24px;
            font-size: 14px;
            border-radius: 30px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn.active {
            background: #4CC3D9;
            border-color: #4CC3D9;
            color: #000;
        }
        /* 状態表示ログ */
        #debug-log {
            position: fixed;
            bottom: 80px; /* 下部のARボタンと被らない位置 */
            left: 10px;
            color: yellow;
            font-family: monospace;
            font-size: 14px;
            z-index: 9999;
            text-shadow: 1px 1px 2px black;
            pointer-events: none;
        }
    </style>

    <script>
        let selectedModelId = 'model-acorn';

        // ログ表示用関数
        function log(text) {
            const el = document.getElementById('debug-log');
            if(el) el.innerHTML = text;
            console.log(text);
        }

        AFRAME.registerComponent('ar-logic', {
            init: function () {
                const scene = this.el.sceneEl;
                this.reticle = document.querySelector('#reticle');
                
                // ARモードに入ったらUIを表示
                scene.addEventListener('enter-vr', () => {
                    document.getElementById('ui-overlay').style.display = 'block';
                    log("AR Started. Move camera slowly.");
                });
                
                scene.addEventListener('exit-vr', () => {
                    document.getElementById('ui-overlay').style.display = 'none';
                    log("AR Stopped.");
                });

                // 画面タップ時の処理
                this.el.sceneEl.addEventListener('click', () => {
                    this.placeModel();
                });
            },

            placeModel: function() {
                const targetModel = document.querySelector('#' + selectedModelId);
                if (!targetModel) return;

                // A. レティクル（リング）が見えている場合 -> そこに配置
                if (this.reticle && this.reticle.getAttribute('visible')) {
                    targetModel.object3D.position.copy(this.reticle.object3D.position);
                    targetModel.setAttribute('visible', 'true');
                    log("Placed " + selectedModelId + " on floor.");
                } 
                // B. レティクルが見えない場合 -> カメラの目の前に配置 (強制配置)
                else {
                    const camera = document.querySelector('[camera]');
                    // カメラの位置と回転を取得
                    const position = new THREE.Vector3();
                    const direction = new THREE.Vector3();
                    camera.object3D.getWorldPosition(position);
                    camera.object3D.getWorldDirection(direction);
                    
                    // 目の前 1メートル (-direction) の位置を計算
                    // ※getWorldDirectionはZマイナス方向を向くため、単純に加算
                    direction.multiplyScalar(-1.0); 
                    position.add(direction);

                    // 高さはカメラより少し下にする(適当な補正)
                    position.y -= 0.5;

                    targetModel.object3D.position.copy(position);
                    targetModel.setAttribute('visible', 'true');
                    log("Force placed " + selectedModelId + " in air.");
                }
            }
        });

        // 距離判定ロジック
        AFRAME.registerComponent('distance-check', {
            tick: function () {
                const acorn = document.querySelector('#model-acorn');
                const pain = document.querySelector('#model-pain');

                if (acorn.getAttribute('visible') && pain.getAttribute('visible')) {
                    const dist = acorn.object3D.position.distanceTo(pain.object3D.position);
                    if (dist < 0.5) { // 50cm
                        log("HIT!! Distance: " + dist.toFixed(2) + "m");
                        pain.object3D.rotation.y += 0.1; // 回転演出
                    } else {
                        log("Distance: " + dist.toFixed(2) + "m");
                    }
                }
            }
        });

        function selectModel(id) {
            selectedModelId = id;
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            if(id === 'model-acorn') document.getElementById('btn-acorn').classList.add('active');
            else document.getElementById('btn-pain').classList.add('active');
            log("Selected: " + id + ". Tap screen to place.");
        }
    </script>
</head>

<body>
    <div id="debug-log">Waiting for AR...</div>

    <div id="ui-overlay">
        <button id="btn-acorn" class="btn active" onclick="selectModel('model-acorn')">Acorn (ドングリ)</button>
        <button id="btn-pain" class="btn" onclick="selectModel('model-pain')">Pineapple (パイン)</button>
        <br>
        <span style="font-size:12px; color:white; background:rgba(0,0,0,0.5);">Tap screen to place model</span>
    </div>

    <a-scene embedded 
             webxr="requiredFeatures: hit-test, local-floor; optionalFeatures: dom-overlay; overlayElement: #ui-overlay"
             ar-logic
             distance-check>

        <a-entity id="model-acorn" gltf-model="url(acorn.glb)" scale="5 5 5" visible="false"></a-entity>

        <a-entity id="model-pain" gltf-model="url(pain.glb)" scale="0.005 0.005 0.005" visible="false"></a-entity>

        <a-entity id="reticle"
                  ar-hit-test-target
                  geometry="primitive: ring; radiusInner: 0.1; radiusOuter: 0.15"
                  material="color: cyan; shader: flat"
                  rotation="-90 0 0"
                  visible="false">
        </a-entity>

        <a-entity light="type: ambient; intensity: 1.5;"></a-entity>
        <a-entity light="type: directional; intensity: 1;" position="-1 1 0"></a-entity>
        
        <a-entity camera position="0 1.6 0"></a-entity>

    </a-scene>
</body>
</html>
