<!DOCTYPE html>
<html>
<head>
    <title>AR Debug Mode</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: black;
        }
        
        /* コンソールログ表示エリア (画面上部) */
        #console-log {
            position: fixed; top: 0; left: 0; width: 100%; height: 50%;
            background: rgba(0,0,0,0.7); pointer-events: none; z-index: 99999;
            overflow-y: scroll; color: lime; font-family: monospace; font-size: 12px;
            padding: 10px; box-sizing: border-box;
            display: block; /* 強制表示 */
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #333; }
        .error-line { color: #FF4444; font-weight: bold; background: rgba(50,0,0,0.5); }
        .warn-line { color: #FFFF00; }
    </style>

    <script>
        // --- 画面上のコンソール機能 ---
        function logToScreen(msg, type='info') {
            const consoleEl = document.getElementById('console-log');
            if (!consoleEl) return;
            
            const line = document.createElement('div');
            line.className = 'log-line ' + (type === 'error' ? 'error-line' : '');
            // 時間を表示
            const time = new Date().toLocaleTimeString();
            line.innerText = `[${time}] ${msg}`;
            
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight; // 最新へスクロール
            console.log(msg);
        }

        // エラーを捕捉して表示
        window.onerror = function(msg, url, line, col, error) {
            logToScreen(`ERROR: ${msg} (Line:${line})`, 'error');
            return false;
        };

        // 読み込みチェック
        window.addEventListener('load', () => {
            logToScreen("Page Loaded. Checking environment...");

            // 1. プロトコルチェック
            if (location.protocol !== 'https:') {
                logToScreen("WARNING: You are using HTTP. Camera requires HTTPS!", 'error');
                alert("警告: HTTPSでアクセスしてください。カメラが起動しません。");
            } else {
                logToScreen("Protocol is HTTPS (OK).");
            }

            // 2. WebGLチェック
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (!gl) {
                logToScreen("CRITICAL: WebGL not supported!", 'error');
            } else {
                logToScreen("WebGL is supported.");
            }
        });

        // A-Frameのシーン読み込み完了
        AFRAME.registerComponent('scene-logger', {
            init: function() {
                logToScreen("A-Frame Scene Initialized.");
                
                const scene = this.el.sceneEl;
                scene.addEventListener('camera-init', (data) => {
                    logToScreen("AR.js Camera Initialized!");
                });
                
                scene.addEventListener('camera-error', (error) => {
                    logToScreen("AR.js Camera Error: " + JSON.stringify(error), 'error');
                });
            }
        });
    </script>
</head>

<body>
    <div id="console-log">
        <div class="log-line">System initializing...</div>
    </div>

    <a-scene embedded 
             arjs="sourceType: webcam; debugUIEnabled: false;"
             renderer="logarithmicDepthBuffer: true; colorManagement: true; alpha: true;"
             vr-mode-ui="enabled: false"
             scene-logger>

        <a-entity camera position="0 1.6 0"></a-entity>

        <a-entity light="type: ambient; intensity: 1.0; color: #fff;"></a-entity>
        <a-entity light="type: directional; intensity: 1.0; position: 1 1 1;"></a-entity>

        <a-box position="0 0 -2" 
               color="red" 
               scale="0.5 0.5 0.5"
               animation="property: rotation; to: 0 360 0; loop: true; dur: 3000">
        </a-box>

    </a-scene>
</body>
</html>
